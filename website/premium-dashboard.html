<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Premium Users Dashboard</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #111827;
      --gold: #f6c945;
      --text: #f5f7fb;
      --muted: #9da9bf;
      --ok: #46d789;
      --bad: #f25f5c;
      --week: #6ab8ff;
      --month: #6696ff;
      --life: #f6c945;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: radial-gradient(1100px 700px at 10% -10%, #1a2b4f, var(--bg));
      color: var(--text);
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      padding: 18px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 30px;
    }

    h1 {
      color: var(--gold);
      margin: 0;
      font-size: clamp(1.6rem, 3.5vw, 2.4rem);
    }

    header p {
      color: var(--muted);
      margin-top: 10px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 14px;
      margin-bottom: 26px;
    }

    .stat-card {
      background: linear-gradient(180deg, #1a2542, var(--panel));
      border: 1px solid rgba(246, 201, 69, 0.35);
      border-radius: 10px;
      padding: 16px;
      text-align: center;
    }

    .stat-card h3 {
      margin: 0 0 8px;
      color: var(--gold);
      font-size: 0.78rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      opacity: 0.9;
    }

    .number {
      font-size: 1.9rem;
      font-weight: 700;
      color: var(--text);
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 14px;
    }

    button {
      padding: 10px 14px;
      border: none;
      border-radius: 6px;
      font-weight: 700;
      cursor: pointer;
      background: var(--gold);
      color: #1f2937;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .message {
      min-height: 30px;
      margin-bottom: 10px;
      color: var(--muted);
    }

    .ok { color: var(--ok); }
    .err { color: var(--bad); }

    .table-wrap {
      background: var(--panel);
      border: 1px solid rgba(246, 201, 69, 0.35);
      border-radius: 10px;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 760px;
    }

    th {
      text-align: left;
      color: var(--gold);
      font-size: 0.84rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      padding: 12px;
      border-bottom: 1px solid rgba(246, 201, 69, 0.35);
    }

    td {
      padding: 11px 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      color: #dfe4ee;
    }

    tr:hover { background: rgba(255, 255, 255, 0.03); }

    .badge {
      display: inline-block;
      font-size: 0.78rem;
      border-radius: 999px;
      padding: 4px 8px;
      font-weight: 700;
    }

    .badge-weekly {
      color: var(--week);
      background: rgba(106, 184, 255, 0.16);
    }

    .badge-monthly {
      color: var(--month);
      background: rgba(102, 150, 255, 0.18);
    }

    .badge-lifetime {
      color: var(--life);
      background: rgba(246, 201, 69, 0.18);
    }

    .badge-active {
      color: var(--ok);
      background: rgba(70, 215, 137, 0.14);
    }

    .badge-inactive {
      color: var(--bad);
      background: rgba(242, 95, 92, 0.14);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Premium Users Dashboard</h1>
      <p>Track weekly, monthly, and lifetime subscriptions.</p>
    </header>

    <div class="stats-grid">
      <div class="stat-card"><h3>Total Users</h3><div class="number" id="totalUsers">-</div></div>
      <div class="stat-card"><h3>Active Users</h3><div class="number" id="activeUsers">-</div></div>
      <div class="stat-card"><h3>Weekly</h3><div class="number" id="weeklyUsers">-</div></div>
      <div class="stat-card"><h3>Monthly</h3><div class="number" id="monthlyUsers">-</div></div>
      <div class="stat-card"><h3>Lifetime</h3><div class="number" id="lifetimeUsers">-</div></div>
      <div class="stat-card"><h3>Total Revenue</h3><div class="number" id="totalRevenue">-</div></div>
    </div>

    <div class="controls">
      <button onclick="loadData()" id="refreshBtn">Refresh</button>
      <button onclick="sendWebhook(event)" id="webhookBtn">Send Webhook</button>
      <button onclick="downloadCSV()">Download CSV</button>
    </div>

    <div id="message" class="message"></div>

    <div class="table-wrap">
      <table id="usersTable">
        <thead>
          <tr>
            <th>User ID</th>
            <th>Email</th>
            <th>Plan</th>
            <th>Status</th>
            <th>Purchased</th>
            <th>Expires</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr><td colspan="6">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    function setMessage(text, type = "") {
      const el = document.getElementById("message");
      el.className = "message" + (type ? ` ${type}` : "");
      el.textContent = text;
    }

    function formatDate(value) {
      if (!value || value.includes("Never")) return "Never";
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return "Unknown";
      return date.toLocaleDateString();
    }

    function planBadge(plan) {
      const normalized = String(plan || "monthly").toLowerCase();
      if (normalized === "weekly") {
        return '<span class="badge badge-weekly">Weekly</span>';
      }
      if (normalized === "lifetime") {
        return '<span class="badge badge-lifetime">Lifetime</span>';
      }
      return '<span class="badge badge-monthly">Monthly</span>';
    }

    function statusBadge(status) {
      return String(status || "").toLowerCase().includes("active")
        ? '<span class="badge badge-active">Active</span>'
        : '<span class="badge badge-inactive">Inactive</span>';
    }

    function updateStats(stats) {
      document.getElementById("totalUsers").textContent = stats.totalUsers || 0;
      document.getElementById("activeUsers").textContent = stats.activeUsers || 0;
      document.getElementById("weeklyUsers").textContent = stats.weeklySubscribers || 0;
      document.getElementById("monthlyUsers").textContent = stats.monthlySubscribers || 0;
      document.getElementById("lifetimeUsers").textContent = stats.lifetimeUsers || 0;
      document.getElementById("totalRevenue").textContent = "INR " + (stats.totalRevenueInRupees || "0");
    }

    function populateTable(users) {
      const tbody = document.getElementById("tableBody");
      tbody.innerHTML = "";

      if (!users.length) {
        tbody.innerHTML = '<tr><td colspan="6">No premium users yet.</td></tr>';
        return;
      }

      users.forEach((user) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td><code>${user.userId}</code></td>
          <td>${user.email || "N/A"}</td>
          <td>${planBadge(user.plan)}</td>
          <td>${statusBadge(user.status)}</td>
          <td>${formatDate(user.purchasedAt)}</td>
          <td>${formatDate(user.expiresAt)}</td>
        `;
        tbody.appendChild(row);
      });
    }

    async function loadData() {
      try {
        const [logRes, statsRes] = await Promise.all([
          fetch("/api/premium-log"),
          fetch("/api/premium-stats")
        ]);

        const logData = await logRes.json();
        const statsData = await statsRes.json();

        if (!logData.success) {
          setMessage("Failed to load premium log.", "err");
          return;
        }

        populateTable(logData.log || []);
        if (statsData.success) {
          updateStats(statsData.stats || {});
        }

        setMessage(`Loaded ${logData.totalRecords || 0} records.`, "ok");
      } catch (error) {
        setMessage("Error loading data: " + error.message, "err");
      }
    }

    async function sendWebhook(event) {
      const btn = event.currentTarget;
      btn.disabled = true;
      btn.textContent = "Sending...";

      try {
        const res = await fetch("/api/webhook-premium-users", { method: "POST" });
        const data = await res.json();

        if (data.success) {
          setMessage("Webhook sent successfully.", "ok");
        } else {
          setMessage("Failed to send webhook.", "err");
        }
      } catch (error) {
        setMessage("Webhook error: " + error.message, "err");
      } finally {
        btn.disabled = false;
        btn.textContent = "Send Webhook";
      }
    }

    function downloadCSV() {
      const rows = document.querySelectorAll("#usersTable tr");
      let csv = "User ID,Email,Plan,Status,Purchased,Expires\n";

      rows.forEach((row, index) => {
        if (index === 0) return;
        const cols = row.querySelectorAll("td");
        if (!cols.length) return;

        const values = Array.from(cols).map((col) => {
          return `"${col.textContent.trim().replace(/"/g, '""')}"`;
        });

        csv += values.join(",") + "\n";
      });

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = `premium-users-${new Date().toISOString().slice(0, 10)}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    loadData();
    setInterval(loadData, 30000);
  </script>
</body>
</html>
